/**
 * Physics
 * A requirified port of Traer Physics from Processing to JavaScript.
 * Copyright (C) 2012 jonobr1
 * 
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 * 
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 * 
 * You should have received a copy of the GNU General Public License
 * along with this program. If not, see <http://www.gnu.org/licenses/>.
 */
(function(){common=function(){var e={},f=Array.prototype,a=Object.prototype,c=a.hasOwnProperty,h=f.slice,d=f.forEach,k=f.indexOf,b=a.toString,g=function(b,c,a){if(null!=b)if(d&&b.forEach===d)b.forEach(c,a);else if(b.length===+b.length)for(var g=0,h=b.length;g<h&&!(g in b&&c.call(a,b[g],g,b)===e);g++);else for(g in b)if(_.has(b,g)&&c.call(a,b[g],g,b)===e)break},q=function(b){return b},m=function(b,c,g){g||(g=q);for(var a=0,d=b.length;a<d;){var h=a+d>>1;g(b[h])<g(c)?a=h+1:d=h}return a};return{has:function(b,
g){return c.call(b,g)},each:g,extend:function(b){g(h.call(arguments,1),function(g){for(var c in g)b[c]=g[c]});return b},indexOf:function(b,g,c){if(null==b)return-1;var a;if(c)return c=m(b,g),b[c]===g?c:-1;if(k&&b.indexOf===k)return b.indexOf(g);c=0;for(a=b.length;c<a;c++)if(c in b&&b[c]===g)return c;return-1},sortedIndex:m,identity:q,isNumber:function(c){return"[object Number]"==b.call(c)},isFunction:function(c){return"[object Function]"==b.call(c)||"function"==typeof c},isUndefined:function(b){return void 0===
b},isNull:function(b){return null===b}}}();Vector=function(e){var f=function(a,c){this.x=a||0;this.y=c||0};e.extend(f.prototype,{set:function(a,c){this.x=a;this.y=c;return this},copy:function(a){this.x=a.x;this.y=a.y;return this},clear:function(){this.y=this.x=0;return this},clone:function(){return new f(this.x,this.y)},add:function(a,c){this.x=a.x+c.x;this.y=a.y+c.y;return this},addSelf:function(a){this.x+=a.x;this.y+=a.y;return this},sub:function(a,c){this.x=a.x-c.x;this.y=a.y-c.y;return this},
subSelf:function(a){this.x-=a.x;this.y-=a.y;return this},multiplySelf:function(a){this.x*=a.x;this.y*=a.y;return this},multiplyScalar:function(a){this.x*=a;this.y*=a;return this},divideScalar:function(a){a?(this.x/=a,this.y/=a):this.set(0,0);return this},negate:function(){return this.multiplyScalar(-1)},dot:function(a){return this.x*a.x+this.y*a.y},lengthSquared:function(){return this.x*this.x+this.y*this.y},length:function(){return Math.sqrt(this.lengthSquared())},normalize:function(){return this.divideScalar(this.length())},
distanceTo:function(a){return Math.sqrt(this.distanceToSquared(a))},distanceToSquared:function(a){var c=this.x-a.x;a=this.y-a.y;return c*c+a*a},setLength:function(a){return this.normalize().multiplyScalar(a)},equals:function(a){return 1E-4>this.distanceTo(a)},lerp:function(a,c){return this.set((a.x-this.x)*c+this.x,(a.y-this.y)*c+this.y)},isZero:function(){return 1E-4>this.length()}});return f}(common);this.Physics=Physics=function(e,f,a){function c(){var d=this;this.tick(1,this.updateStep);a.each(this.animations,
function(c){c()});(this.__optimized&&!this.__equilibrium||!this.__optimized)&&this.playing&&f(function(){c.call(d)});this.__optimized&&this.__equilibrium&&a.each(this.equilibriumCallbacks,function(c){c()})}var h=function(){this.playing=!1;e.apply(this,arguments);this.animations=[];this.equilibriumCallbacks=[];this.updateStep=1;c.call(this)};a.extend(h,e,{superclass:e});a.extend(h.prototype,e.prototype,{play:function(a){this.updateStep=a||1;if(this.playing)return this;this.playing=!0;this.__equilibrium=
!1;c.call(this);return this},pause:function(){this.playing=!1;return this},toggle:function(){this.playing?this.pause():this.play(this.updateStep);return this},onUpdate:function(c){if(0<=a.indexOf(this.animations,c)||!a.isFunction(c))return this;this.animations.push(c);return this},onEquilibrium:function(c){if(0<=a.indexOf(this.equilibriumCallbacks,c)||!a.isFunction(c))return this;this.equilibriumCallbacks.push(c);return this},update:function(){if(!this.__equilibrium)return this;this.__equilibrium=
!1;this.playing&&c.call(this);return this}});return h}(ParticleSystem=function(e,f,a,c,h,d){var k=function(){this.__equilibriumCriteria={particles:!0,springs:!0,attractions:!0};this.__optimized=this.__equilibrium=!1;this.particles=[];this.springs=[];this.attractions=[];this.forces=[];this.integrator=new h(this);this.hasDeadParticles=!1;var b=arguments.length;1===b?(this.gravity=new e(0,arguments[0]),this.drag=k.DEFAULT_DRAG):2===b?(this.gravity=new e(0,arguments[0]),this.drag=arguments[1]):3===b?
(this.gravity=new e(arguments[0],arguments[1]),this.drag=arguments[3]):(this.gravity=new e(0,k.DEFAULT_GRAVITY),this.drag=k.DEFAULT_DRAG)};d.extend(k,{DEFAULT_GRAVITY:0,DEFAULT_DRAG:0.001,Attraction:c,Integrator:h,Particle:f,Spring:a,Vector:e});d.extend(k.prototype,{optimize:function(b){this.__optimized=!!b;return this},setGravity:function(b,c){this.gravity.set(b,c);return this},setEquilibriumCriteria:function(b,c,a){this.__equilibriumCriteria.particles=!!b;this.__equilibriumCriteria.springs=!!c;
this.__equilibriumCriteria.attractions=!!a},tick:function(b,c){b=b||1;for(var a=(c||1)-1;0<=a;a--)this.integrator.step(b);this.__optimized&&(this.__equilibrium=!this.needsUpdate());return this},needsUpdate:function(){var b=0;if(this.__equilibriumCriteria.particles)for(b=0,l=this.particles.length;b<l;b++)if(!this.particles[b].resting())return!0;if(this.__equilibriumCriteria.springs)for(b=0,l=this.springs.length;b<l;b++)if(!this.springs[b].resting())return!0;if(this.__equilibriumCriteria.attractions)for(b=
0,l=this.attractions.length;b<l;b++)if(!this.attractions[b].resting())return!0;return!1},addParticle:function(b){this.particles.push(b);return this},addSpring:function(b){this.springs.push(b);return this},addAttraction:function(b){this.attractions.push(b);return this},makeParticle:function(b,c,a){b=d.isNumber(b)?b:1;c=c||0;a=a||0;b=new f(b);b.position.set(c,a);this.addParticle(b);return b},makeSpring:function(b,c,h,d,e){b=new a(b,c,h,d,e);this.addSpring(b);return b},makeAttraction:function(b,a,h,
d){b=new c(b,a,h,d);this.addAttraction(b);return b},clear:function(){this.particles.length=0;this.springs.length=0;this.attractions.length=0},applyForces:function(){this.gravity.isZero()||d.each(this.particles,function(b){b.force.addSelf(this.gravity)},this);var b=new e;d.each(this.particles,function(c){b.set(-1*c.velocity.x*this.drag,-1*c.velocity.y*this.drag);c.force.addSelf(b)},this);d.each(this.springs,function(b){b.update()});d.each(this.attractions,function(b){b.update()});d.each(this.forces,
function(b){b.update()});return this},clearForces:function(){d.each(this.particles,function(b){b.clear()});return this}});return k}(Vector,Particle=function(e,f){var a=function(c){this.position=new e;this.velocity=new e;this.force=new e;this.mass=c;this.fixed=!1;this.age=0;this.dead=!1};f.extend(a.prototype,{distanceTo:function(c){return this.position.distanceTo(c.position)},makeFixed:function(){this.fixed=!0;this.velocity.clear();return this},reset:function(){this.age=0;this.dead=!1;this.position.clear();
this.velocity.clear();this.force.clear();this.mass=1;return this},resting:function(){return this.fixed||this.velocity.isZero()&&this.force.isZero()}});return a}(Vector,common),Spring=function(e,f){var a=function(c,a,d,e,b){this.constant=d;this.damping=e;this.length=b;this.a=c;this.b=a;this.on=!0};f.extend(a.prototype,{currentLength:function(){return this.a.position.distanceTo(this.b.position)},update:function(){var c=this.a,a=this.b;if(!this.on||c.fixed&&a.fixed)return this;var d=(new e).sub(c.position,
a.position),k=d.length();0===k?d.clear():d.divideScalar(k);var k=-1*(k-this.length)*this.constant,b=(new e).sub(c.velocity,a.velocity),b=-1*this.damping*b.dot(d);d.multiplyScalar(k+b);c.fixed||c.force.addSelf(d);a.fixed||a.force.subSelf(d);return this},resting:function(){var c=this.a,a=this.b,d=this.length;return!this.on||c.fixed&&a.fixed||c.fixed&&(0===d?a.position.equals(c.position):a.position.distanceTo(c.position)<=d)&&a.resting()||a.fixed&&(0===d?c.position.equals(a.position):c.position.distanceTo(a.position)<=
d)&&c.resting()}});return a}(Vector,common),Attraction=function(e,f){var a=function(c,a,d,e){this.a=c;this.b=a;this.constant=d;this.on=!0;this.distanceMin=e;this.distanceMinSquared=e*e};f.extend(a.prototype,{update:function(){var c=this.a,a=this.b;if(!(!this.on||c.fixed&&a.fixed)){var d=(new e).sub(c.position,a.position),f=Math.max(d.lengthSquared(),this.distanceMinSquared),b=this.constant*c.mass*a.mass/f,f=Math.sqrt(f);0===b||0===f?d.clear():d.divideScalar(f).multiplyScalar(b);c.fixed||c.force.subSelf(d);
a.fixed||a.force.addSelf(d);return this}},resting:function(){var c=this.a,a=this.b,d=this.distanceMin;return!this.on||c.fixed&&a.fixed||c.fixed&&a.position.distanceTo(c.position)<=d&&a.resting()||a.fixed&&c.position.distanceTo(a.position)<=d&&c.resting()}});return a}(Vector,common),Integrator=function(e,f){var a=function(c){this.s=c;this.originalPositions=[];this.originalVelocities=[];this.k1Forces=[];this.k1Velocities=[];this.k2Forces=[];this.k2Velocities=[];this.k3Forces=[];this.k3Velocities=[];
this.k4Forces=[];this.k4Velocities=[]};f.extend(a.prototype,{allocateParticles:function(){for(;this.s.particles.length>this.originalPositions.length;)this.originalPositions.push(new e),this.originalVelocities.push(new e),this.k1Forces.push(new e),this.k1Velocities.push(new e),this.k2Forces.push(new e),this.k2Velocities.push(new e),this.k3Forces.push(new e),this.k3Velocities.push(new e),this.k4Forces.push(new e),this.k4Velocities.push(new e);return this},step:function(c){var a=this.s,d,e;this.allocateParticles();
f.each(a.particles,function(b,a){b.fixed||(this.originalPositions[a].copy(b.position),this.originalVelocities[a].copy(b.velocity));b.force.clear()},this);a.applyForces();f.each(a.particles,function(b,a){b.fixed||(this.k1Forces[a].copy(b.force),this.k1Velocities[a].copy(b.velocity));b.force.clear()},this);f.each(a.particles,function(b,a){if(!b.fixed){var f=this.originalPositions[a],m=this.k1Velocities[a];d=f.x+0.5*m.x*c;e=f.y+0.5*m.y*c;b.position.set(d,e);f=this.originalVelocities[a];m=this.k1Forces[a];
d=f.x+0.5*m.x*c/b.mass;e=f.y+0.5*m.y*c/b.mass;b.velocity.set(d,e)}},this);a.applyForces();f.each(a.particles,function(b,a){b.fixed||(this.k2Forces[a].copy(b.force),this.k2Velocities[a].copy(b.velocity));b.force.clear()},this);f.each(a.particles,function(b,a){if(!b.fixed){var d=this.originalPositions[a],e=this.k2Velocities[a];b.position.set(d.x+0.5*e.x*c,d.y+0.5*e.y*c);d=this.originalVelocities[a];e=this.k2Forces[a];b.velocity.set(d.x+0.5*e.x*c/b.mass,d.y+0.5*e.y*c/b.mass)}},this);a.applyForces();
f.each(a.particles,function(b,a){b.fixed||(this.k3Forces[a].copy(b.force),this.k3Velocities[a].copy(b.velocity));b.force.clear()},this);f.each(a.particles,function(a,d){if(!a.fixed){var e=this.originalPositions[d],f=this.k3Velocities[d];a.position.set(e.x+f.x*c,e.y+f.y*c);e=this.originalVelocities[d];f=this.k3Forces[d];a.velocity.set(e.x+f.x*c/a.mass,e.y+f.y*c/a.mass)}},this);a.applyForces();f.each(a.particles,function(a,c){a.fixed||(this.k4Forces[c].copy(a.force),this.k4Velocities[c].copy(a.velocity))},
this);f.each(a.particles,function(a,d){a.age+=c;if(!a.fixed){var e=this.originalPositions[d],f=this.k1Velocities[d],h=this.k2Velocities[d],k=this.k3Velocities[d],n=this.k4Velocities[d],p=e.x+c/6*(f.x+2*h.x+2*k.x+n.x),e=e.y+c/6*(f.y+2*h.y+2*k.y+n.y);a.position.set(p,e);e=this.originalVelocities[d];f=this.k1Forces[d];h=this.k2Forces[d];k=this.k3Forces[d];n=this.k4Forces[d];p=e.x+c/(6*a.mass)*(f.x+2*h.x+2*k.x+n.x);e=e.y+c/(6*a.mass)*(f.y+2*h.y+2*k.y+n.y);a.velocity.set(p,e)}},this);return this}});return a}(Vector,
common),common),requestAnimationFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1E3/60)}}(),common)})();